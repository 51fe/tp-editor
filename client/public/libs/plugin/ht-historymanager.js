!function(s,g,P){"use strict";var H="ht",S=s[H],N=S.Default,T=N.def,L=N.getInternal();S.HistoryManager=function(y){this._histories=[],this.setDataModel(y)},T(S.HistoryManager,g,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var M=this;M._betweenTransaction++,1===M._betweenTransaction&&(M._transactionHistories={})}},endTransaction:function(){if(0!==this._betweenTransaction){var A=this,T=A._histories;if(A._betweenTransaction>0&&A._betweenTransaction--,0===A._betweenTransaction){if(A._transactionHistories){var j=[];for(var k in A._transactionHistories)j.push(A._transactionHistories[k]);j.length&&(T=T.slice(0,A._historyIndex+1),T.push(j),T.length>A._maxHistoryCount&&(T=T.slice(T.length-A._maxHistoryCount)),A.setHistories(T),A.setHistoryIndex(T.length-1,!0))}delete A._transactionHistories}}},setDataModel:function(F){var c=this,Z=c._dataModel;Z!==F&&(Z&&(delete Z._historyManager,Z.ump(c.handleDataModelPropertyChange,c),Z.umm(c.$5p,c),Z.umd(c.$6p,c),Z.removeHierarchyChangeListener(c.handleHierarchyChange,c),Z.removeIndexChangeListener(c.handleIndexChange,c)),c._dataModel=F,F&&(F._historyManager=c,F.mp(c.handleDataModelPropertyChange,c),F.mm(c.$5p,c),F.md(c.$6p,c),F.addHierarchyChangeListener(c.handleHierarchyChange,c),F.addIndexChangeListener(c.handleIndexChange,c)),c.fp("dataModel",Z,F),c.clear())},setHistoryIndex:function(j,A){var s=this,T=s._historyIndex,b=s._histories.length;if(-1>j?j=-1:j>=b&&(j=b-1),T!==j){if(!A){var t=j-T;t>0?s.$2p(t):0>t&&s.$1p(-t)}s._historyIndex=j,s.fp("historyIndex",T,j),s.dataModel&&s.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(Z){var X=this,y=X._histories,Q=X._maxHistoryCount;(!Z||0>=Z)&&(Z=10),Q!==Z&&(X._maxHistoryCount=Z,X.fp("maxHistoryCount",Q,Z),y.length>Z&&X.clear())},cloneValue:function(i){return S.Default.clone(i)},isPropertyUndoable:function(p){return p&&!this.ignoredPropertyMap[p]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(e){return e&&!this.ignoreDataModelPropertyMap[e]},$5p:function(s){this.handleChange(s,s.kind)},$6p:function($){this.handleChange($,"property")},handleHierarchyChange:function(g){this.handleChange(g,"hierarchy")},handleIndexChange:function(t){this.handleChange(t,"index")},handleDataModelPropertyChange:function(J){this.handleChange(J,"dataModelProperty")},toChildrenInfo:function(q){var d={};return d.data=q,d.children=[],q.eachChild(function(R){d.children.push(this.toChildrenInfo(R))},this),d},restoreChildren:function(G){var y=G.data;G.children.forEach(function(h){var n=h.data;n.getParent()!==y&&y.addChild(n),this._dataModel.contains(n)||this._dataModel.add(n),this.restoreChildren(h)},this)},handleChange:function(n,o){var y=this;if(!(y._disabled||y._isUndoRedoing||N.loadingRefGraph)){var w,Q=(y._histories,n.data),m=n.property;if(!Q||!(Q._refGraph||Q instanceof S.RefGraph)){if("property"===o)y.isPropertyUndoable(m,Q)&&(w={kind:o,data:Q,property:m,oldValue:y.cloneValue(n.oldValue,Q,m),newValue:y.cloneValue(n.newValue,Q,m),event:n});else if("hierarchy"===o||"index"===o&&y.isIndexUndoable(n))w={kind:o,data:Q,oldIndex:n.oldIndex,newIndex:n.newIndex,event:n};else if("clear"===o)w={kind:o,json:n.json,event:n};else if("add"===o){if(w={kind:o,data:Q,event:n,childrenInfo:this.toChildrenInfo(Q),parent:Q.getParent()},w.parent){var a=y._dataModel.getSiblings(Q);w.siblingsIndex=a.indexOf(Q)}Q instanceof S.Node&&(w.host=Q.getHost(),w.attaches=Q.getAttaches()?Q.getAttaches().toArray():P),Q instanceof S.Edge&&(w.source=Q.getSource(),w.target=Q.getTarget())}else"remove"===o?w={kind:o,data:Q,event:n}:"dataModelProperty"===o&&y.isDataModelPropertyUndoable(m,Q)&&(w={kind:o,property:m,oldValue:y.cloneValue(n.oldValue,Q,m),newValue:y.cloneValue(n.newValue,Q,m),event:n});y.addHistory(w)}}},addHistory:function(f){var W=this;if(f)if(W._betweenTransaction){var Y=(f.data?f.data._id:0)+"_"+f.kind+"_"+f.property;if("property"===f.kind||"dataModelProperty"===f.kind){var c=W._transactionHistories[Y];c&&(f.oldValue=c.oldValue)}W._transactionHistories[Y]=f}else{var U=W._histories;U=U.slice(0,W._historyIndex+1),U.push([f]),U.length>W._maxHistoryCount&&(U=U.slice(U.length-W._maxHistoryCount)),W.setHistories(U),W.setHistoryIndex(U.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(Z){(!Z||0>=Z)&&(Z=1),this.setHistoryIndex(this._historyIndex-Z)},$1p:function(z){if(this.canUndo()){var K,f=this,u=f._dataModel,C=f._histories,d=f._historyIndex,b=0;for(f._isUndoRedoing=!0,N.setIsolating(!0);z>0;){if(d>=0&&d<C.length){b++,K=C[d],d--;for(var D=K.length-1;D>=0;D--){var k=K[D],Z=k.kind,S=k.data,H=k.property,l=k.event,B=this.cloneValue(k.oldValue,S,H);if(k.undo)k.undo();else if("add"===Z)u.remove(S,{keepChildren:!0});else if("remove"===Z)u.contains(S)||u.add(S,l.rootsIndex,l.datasIndex);else if("clear"===Z)u.deserialize(N.clone(k.json));else if("property"===Z)if("parent"===H)B?B.addChild(S,l.oldIndex):(S.setParent(B),l.oldIndex>=0&&u.moveTo(S,l.oldIndex));else{var r=null;0===H.indexOf("a:")?(r="attr",H=H.replace("a:","")):0===H.indexOf("s:")?(r="style",H=H.replace("s:","")):0===H.indexOf("f:")&&(r="field",H=H.replace("f:","")),L.setPropertyValue(S,r,H,B)}else if("dataModelProperty"===Z){var r=null;0===H.indexOf("a:")?(r="attr",H=H.replace("a:","")):0===H.indexOf("s:")?(r="style",H=H.replace("s:","")):0===H.indexOf("f:")&&(r="field",H=H.replace("f:","")),L.setPropertyValue(u,r,H,B)}else"hierarchy"===Z?u.moveTo(S,k.oldIndex):"index"===Z?u.moveToIndex(S,k.oldIndex):"selection"===Z&&u.sm().ss(k.oldValue)}}z--}N.setIsolating(!1),delete f._isUndoRedoing,f.afterUndo(b)}},afterUndo:function(){},redo:function($){(!$||0>=$)&&($=1),this.setHistoryIndex(this._historyIndex+$)},$2p:function(u){if(this.canRedo()){var O,x=this,U=x._dataModel,l=x._histories,d=x._historyIndex,Z=0;for(x._isUndoRedoing=!0,N.setIsolating(!0);u>0;){if(d>=-1&&d<l.length-1){Z++,d++,O=l[d];for(var P=0;P<O.length;P++){var e=O[P],Q=e.kind,h=e.data,c=e.property,V=e.event,_=this.cloneValue(e.newValue,h,c);if(e.redo)e.redo();else if("add"===Q)e.parent&&!h.getParent()&&e.parent.addChild(h,e.siblingsIndex),U.contains(h)||U.add(h,V.rootsIndex,V.datasIndex),this.restoreChildren(e.childrenInfo),h instanceof S.Node&&(h.setHost(e.host),e.attaches&&e.attaches.forEach(function(K){K.setHost(h)})),h instanceof S.Edge&&(h.setSource(e.source),h.setTarget(e.target));else if("remove"===Q)U.remove(h);else if("clear"===Q)U.clear();else if("property"===Q)if("parent"===c)_?_.addChild(h,V.newIndex):(h.setParent(_),V.newIndex>=0&&U.moveTo(h,V.newIndex));else{var I=null;0===c.indexOf("a:")?(I="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(I="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(I="field",c=c.replace("f:","")),L.setPropertyValue(h,I,c,_)}else if("dataModelProperty"===Q){var I=null;0===c.indexOf("a:")?(I="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(I="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(I="field",c=c.replace("f:","")),L.setPropertyValue(U,I,c,_)}else"hierarchy"===Q?U.moveTo(h,e.newIndex):"index"===Q?U.moveToIndex(h,e.newIndex):"selection"===Q&&U.sm().ss(e.newValue)}}u--}N.setIsolating(!1),delete x._isUndoRedoing,this.afterRedo(Z)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);